<!DOCTYPE html>
<!DOCTYPE html>
<html>

<head>
    <title>Central Bot</title>
    <link rel="stylesheet" href="styles.css">
    <script src="index.js"></script>
    <meta name="viewport" content="width=device-width">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

</head>


<body>
    <img class="logo" src="image/logo.png" alt="">
    <form action="/submit" method="post">
        <input type="text" id="searchname" placeholder="SEARCH NAME" maxlength="25">
        <!-- Поле ввода начальной локации -->
        <div>
            <label>Pick Up location</label>
            <label>City<label class="switch">
                    <input type="checkbox" class="startcheck" onchange="toggleTextInputstart()">
                    <span class="slider round"></span>
                </label>STATE</label>
            <select id="start-location-input-state" style="display: none;">
                <option value="AL">Alabama</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
            </select>
            <input type="text" id="start-location-input" list="search-datalist" autocomplete="off"
                placeholder="Start Location" required>
            <datalist id="search-datalist" size="2"></datalist>
            <input type="number" id="start-location-radius" name="start-location-radius" placeholder="Start Radius"
                required>
            <button type="button" onclick="addStartLocation()">ADD LOCAION</button>
        </div>

        <div id="start-locations-container">
            <!-- Здесь будут отображаться карточки начальных локаций -->
        </div>

        <hr>
        <br>
        <div>
            <label>Delivery location</label>
            <label>CITY<label class="switch">
                    <input type="checkbox" class="endcheck" onchange="toggleTextInputend()">
                    <span class="slider round"></span>
                </label>STATE</label>

            <select id="end-location-input-state" style="display: none;">
                <option value="AL">Alabama</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
            </select>

            <input type="text" id="end-location-input" list="search-datalist" autocomplete="off"
                placeholder="End Location" required>
            <datalist id="search-datalist" size="5"></datalist>
            <input type="number" id="end-location-radius" name="end-location-radius" placeholder="End Radius" required>

            <button type="button" onclick="addEndLocation()">ADD LOCATION</button>
        </div>

        <div id="end-locations-container">
            <!-- Здесь будут отображаться карточки конечных локаций -->
        </div>


        <hr>
        <br>
        <!-- Выбор типа транспортного средства -->
        <div style="text-align: center; font-size: 20px; font-weight: 600; padding-bottom: 20px;">Vehicle Type</div>
        <label><input type="checkbox" id="all-checkbox" name="vehicle-type" value="all">ALL (Default)</label>

        <div class="vehicle-types-container">

            <label><input type="checkbox" name="vehicle-type" value="ATV"> ATV</label>
            <label><input type="checkbox" name="vehicle-type" value="BOAT"> Boat</label>
            <label><input type="checkbox" name="vehicle-type" value="CAR"> Car</label>
            <label><input type="checkbox" name="vehicle-type" value="HEAVY_EQUIPMENT"> Heavy Equip</label>
            <label><input type="checkbox" name="vehicle-type" value="LARGE_YACHT"> Large Yacht</label>
            <label><input type="checkbox" name="vehicle-type" value="MOTORCYCLE"> Motorcycle</label>
            <label><input type="checkbox" name="vehicle-type" value="PICKUP"> Pickup</label>
            <label><input type="checkbox" name="vehicle-type" value="RV"> RV</label>
            <label><input type="checkbox" name="vehicle-type" value="SUV"> SUV</label>
            <label><input type="checkbox" name="vehicle-type" value="TRAVEL_TRAILER"> Travel Trailer</label>
            <label><input type="checkbox" name="vehicle-type" value="VAN"> Van</label>
            <label><input type="checkbox" name="vehicle-type" value="OTHER"> Other</label>

        </div>

        <hr>
        <br>

        <!-- Выбор состояния транспортного средства -->
        <label for="trailer-type">Trailer Type</label>
        <select id="trailer-type" name="trailer-type" onchange="TrailerType(this.value)">
            <option value="all">All (Default)</option>
            <option value="open">Open</option>
            <option value="enclosed">Enclosed</option>
            <option value="driveaway">Driveaway</option>
        </select>

        <br>

        <!-- Выбор состояния транспортного средства -->
        <label for="vehicle-status">Vehicle Status</label>
        <select id="vehicle-status" name="vehicle-status" onchange="VehicleStatus(this.value)">
            <option value="all">All (Default)</option>
            <option value="operable">Operable</option>
            <option value="inoperable">Inoperable</option>
        </select>

        <br>

        <!-- Минимальное количество транспортных средств -->
        <label for="min-vehicles">Min # of Vehicles</label>
        <select id="min-vehicles" name="min-vehicles" onchange="MinVehicles(this.value)">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <!-- и так далее, можно добавить больше опций -->
        </select>
        <br>

        <!-- Максимальное количество транспортных средств -->
        <label for="max-vehicles">Max # of Vehicles</label>
        <select id="max-vehicles" name="max-vehicles" onchange="MaxVehicles(this.value)">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option selected value="10">10</option>
            <!-- и так далее, можно добавить больше опций -->
        </select>
        <br>

        <!-- Выбор даты доставки -->
        <label for="delivery-date">Delivery Date</label>
        <input type="date" id="delivery-date" name="delivery-date" min=="" value="" required
            onchange="DeliveryDate(this.value)">

        <br>

        <!-- Готовность к отправке -->
        <label for="ready-to-ship">Ready to Ship Within</label>
        <select id="ready-to-ship" name="ready-to-ship" onchange="ReadyToShip(this.value)">
            <option value="0">Today</option>
            <option value="1">1 day</option>
            <option value="2">2 days</option>
            <option value="3">3 days</option>
            <option value="4">4 days</option>
            <option value="5">5 days</option>
            <option value="6">6 days</option>
            <option value="7">7 days</option>
            <option value="10">10 days</option>
            <option value="14">14 days</option>
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <!-- и так далее, можно добавить больше опций -->
        </select>

        <br>

        <!-- Минимальная общая стоимость -->
        <label for="min-total-pay">Min Total Pay</label>
        <input type="number" id="min-total-pay" name="min-total-pay" value="400" required
            onchange="MinPayment(this.value)">

        <br>

        <!-- Минимальная ставка за транспортное средство за милю -->
        <label for="min-rate-per-mile">Min rate per vehicle per mile</label>
        <input type="number" id="min-rate-per-mile" name="min-rate-per-mile" value="0.55" required
            onchange="MinPaymentPerMile(this.value)">

        <br>

        <!-- Кнопка отправки формы -->
        <!-- <input type="submit" value="Отправить"> -->
    </form>

</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function getDataFromCSVFile(csvFile, callback) {
        $.ajax({
            url: csvFile,
            dataType: 'text',
            success: function (csvData) {
                var data = [];
                var lines = csvData.split(/\r\n|\n/);
                var headers = lines[0].replace(/"/g, '').split(',');
                var cityIndex = headers.indexOf('city');
                var stateIndex = headers.indexOf('state_id');
                var latIndex = headers.indexOf('lat');
                var lngIndex = headers.indexOf('lng');

                for (var i = 1; i < lines.length; i++) {
                    var obj = {};
                    var currentLine = lines[i].replace(/"/g, '').split(',');
                    obj['city'] = currentLine[cityIndex];
                    obj['state_id'] = currentLine[stateIndex];
                    obj['lat'] = parseFloat(currentLine[latIndex]);
                    obj['lng'] = parseFloat(currentLine[lngIndex]);
                    data.push(obj);
                }
                callback(data);
            }
        });
    }

    async function createAutocomplete(data) {
        var inputstart = document.getElementById('start-location-input');
        var inputend = document.getElementById('end-location-input');
        var datalist = document.getElementById('search-datalist');

        var currentSearch = '';

        inputstart.addEventListener('input', async function (event) {
            currentSearch = inputstart.value;
            await wait(500); // Ожидаем 500 миллисекунд
            searchData(event);
        });

        inputend.addEventListener('input', async function (event) {
            currentSearch = inputend.value;
            await wait(500); // Ожидаем 500 миллисекунд
            searchData(event);
        });

        function searchData(event) {
            currentSearch = event.target.value;
            datalist.innerHTML = '';

            var matchingData = data.filter(function (item) {
                return item.city.toLowerCase().startsWith(currentSearch.toLowerCase());
            });

            // Ограничьте количество отображаемых городов
            var maxResults = 10;
            var limitedData = matchingData.slice(0, maxResults);

            var options = '';
            for (var i = 0; i < limitedData.length; i++) {
                options += '<option value="' + limitedData[i].city + ', ' + limitedData[i].state_id + '">';
            }

            datalist.innerHTML = options;
        }
    }

    // Асинхронная функция для ожидания заданного количества миллисекунд
    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function getDataFromCSVFile(csvFile) {
        try {
            const response = await fetch(csvFile);
            const csvText = await response.text();
            return Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true
            }).data;
        } catch (error) {
            console.error('Error fetching CSV file:', error);
            return [];
        }
    }

    $(document).ready(async function () {
        var csvFile = 'uscities.csv';
        var data = await getDataFromCSVFile(csvFile);
        createAutocomplete(data);
    });


    // Установка минимального значения для элемента input с типом date
    var deliveryDateInput = document.getElementById("delivery-date");
    var today = new Date();
    var minDate = today.toISOString().slice(0, 10);
    deliveryDateInput.min = minDate;

    // Установка значения по умолчанию в американском формате "мм/дд/гггг"
    // var defaultDate = (today.getMonth() + 1).toString().padStart(2, '0') + '/' + today.getDate().toString().padStart(2, '0') + '/' + today.getFullYear();
    // deliveryDateInput.valueAsDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());



    // var startlocations = startlocations
    // var endlocations = endlocations
    // var vehtypes = vehtypes
    // var trailertype = trailertype
    // var vehstatus = vehstatus
    // var vehmin = vehmin
    // var vehmax = vehmax
    // var deliverydate = deliverydate
    // var readytoshipwithin = readytoshipwithin
    // var minpayment = minpayment
    // var minpaymentpermile = minpaymentpermile

</script>

<script>


    var startlocations = []
    var endlocations = []
    var vehtypes = []
    var trailertype = document.getElementById('trailer-type').value
    var vehstatus = document.getElementById('vehicle-status').value
    var vehmin = document.getElementById('min-vehicles').value
    var vehmax = document.getElementById('max-vehicles').value
    var deliverydate = document.getElementById('delivery-date').value
    var readytoshipwithin = document.getElementById('ready-to-ship').value
    var minpayment = document.getElementById('min-total-pay').value
    var minpaymentpermile = document.getElementById('min-rate-per-mile').value
    console.log(trailertype, vehstatus, vehmin, vehmax, deliverydate, readytoshipwithin, minpayment, minpaymentpermile)
    function TrailerType(value) {
        trailertype = value;
        console.log(trailertype)
    }
    function VehicleStatus(value) {
        vehstatus = value;
        console.log(vehstatus)
    }
    function MinVehicles(value) {
        vehmin = value;
        console.log(vehmin)
    }
    function MaxVehicles(value) {
        vehmax = value;
        console.log(vehmax)
    }
    function DeliveryDate(value) {
        deliverydate = value;
        console.log(deliverydate)

    }
    function ReadyToShip(value) {
        readytoshipwithin = value;
        console.log(readytoshipwithin)
    }
    function MinPayment(value) {
        minpayment = value;
        console.log(minpayment)
    }
    function MinPaymentPerMile(value) {
        minpaymentpermile = value;
        console.log(minpaymentpermile)
    }
    function updateVehicleTypes() {
        vehtypes = []; // Сбрасываем массив

        const checkboxes = document.querySelectorAll('input[name="vehicle-type"]');
        const allCheckbox = document.getElementById('all-checkbox');

        checkboxes.forEach(checkbox => {
            if (checkbox.value === 'all') {
                if (checkbox.checked) {
                    vehtypes.push('all');
                    checkboxes.forEach(cb => cb.disabled = true);
                    allCheckbox.disabled = false;
                } else {
                    checkboxes.forEach(cb => cb.disabled = false);
                }
            } else if (checkbox.checked) {
                vehtypes.push(checkbox.value);
            }
        });

        console.log(vehtypes); // Выводим в консоль для проверки
    }

    // Слушатель события изменения состояния флажков
    document.addEventListener('change', function (event) {
        if (event.target && event.target.type === 'checkbox' && event.target.name === 'vehicle-type') {
            if (event.target.value === 'all') {
                const checkboxes = document.querySelectorAll('input[name="vehicle-type"]:not(#all-checkbox)');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = event.target.checked;
                    checkbox.disabled = event.target.checked;
                });
            } else {
                const allCheckbox = document.getElementById('all-checkbox');
                if (!event.target.checked) {
                    allCheckbox.checked = false;
                    allCheckbox.disabled = false;
                } else {
                    const allUnchecked = document.querySelectorAll('input[name="vehicle-type"]:not(#all-checkbox):not(:checked)');
                    if (allUnchecked.length === 0) {
                        allCheckbox.checked = true;
                        allCheckbox.disabled = true;
                    }
                }
            }
        }
        updateVehicleTypes()
    });

    function toggleTextInputend() {
        var checkbox = document.querySelector('.endcheck');
        var textInput = document.getElementById('end-location-input-state');
        var cityinput = document.getElementById('end-location-input');
        var radiusinput = document.getElementById('end-location-radius')

        if (checkbox.checked) {
            textInput.style.display = 'block';
            radiusinput.style.display = 'none'
            cityinput.style.display = 'none'
        } else {
            radiusinput.style.display = 'block'
            cityinput.style.display = 'block'
            textInput.style.display = 'none';
        }
    }
    function toggleTextInputstart() {
        var checkbox = document.querySelector('.startcheck');
        var textInput = document.getElementById('start-location-input-state');
        var cityinput = document.getElementById('start-location-input');
        var radiusinput = document.getElementById('start-location-radius')

        if (checkbox.checked) {
            textInput.style.display = 'block';
            radiusinput.style.display = 'none'
            cityinput.style.display = 'none'
        } else {
            radiusinput.style.display = 'block'
            cityinput.style.display = 'block'
            textInput.style.display = 'none';
        }
    }

    function getLatLngFromCSV(city, state) {
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: "uscities.csv", // Replace with the path to your CSV file
                dataType: 'text',
                success: function (csvData) {
                    var data = [];
                    var lines = csvData.split(/\r\n|\n/);
                    var headers = lines[0].replace(/"/g, '').split(',');
                    var cityIndex = headers.indexOf('city');
                    var stateIndex = headers.indexOf('state_id');
                    var latIndex = headers.indexOf('lat');
                    var lngIndex = headers.indexOf('lng');

                    for (var i = 1; i < lines.length; i++) {
                        var obj = {};
                        var currentLine = lines[i].replace(/"/g, '').split(',');
                        obj['city'] = currentLine[cityIndex];
                        obj['state_id'] = currentLine[stateIndex];
                        obj['lat'] = parseFloat(currentLine[latIndex]);
                        obj['lng'] = parseFloat(currentLine[lngIndex]);
                        data.push(obj);
                    }

                    var cityData = data.find((item) => item.city === city && item.state_id === state);
                    if (cityData) {
                        resolve({ lat: cityData.lat, lng: cityData.lng });
                    } else {
                        resolve(null); // City not found in the CSV data
                    }
                },
                error: function (err) {
                    reject(err);
                }
            });
        });
    }


    // Function to add start location to JSON file and display it on the page
    function addStartLocation() {
        console.log(searchname)
        var startLocationInput = document.getElementById("start-location-input");
        var startLocationRadius = document.getElementById("start-location-radius");
        var startLocationsContainer = document.getElementById("start-locations-container");
        var startstate = document.getElementById("start-location-input-state")
        console.log(startstate.value)
        console.log(startlocations)

        if (startstate.style.display == "block") {
            var hasAL = startlocations.some(function (location) {
                return location.state === startstate.value;
            });

            if (hasAL) {
                startLocationInput.value = "";
                startLocationRadius.value = "";
                return
            }
            var locationCard = document.createElement("div");
            locationCard.className = "location-card";

            locationCard.textContent = startstate.value;

            var removeButton = document.createElement("button");
            removeButton.textContent = "X";
            removeButton.classList.add("Minus");
            removeButton.id = startlocations.length
            removeButton.addEventListener("click", function () {
                startLocationsContainer.removeChild(locationCard);
                console.log(removeButton.id)
                startlocations.splice(parseInt(removeButton.id), 1)
                var minusButtons = startLocationsContainer.getElementsByClassName("Minus");

                // Loop through each button and update its ID
                for (var i = 0; i < minusButtons.length; i++) {
                    minusButtons[i].id = i.toString();
                }
                console.log(startlocations)
            });


            // Get all the button elements with class "Minus" inside the container

            locationCard.appendChild(removeButton);

            startLocationsContainer.appendChild(locationCard);
            var locationData = {
                state: startstate.value,
                city: "",
                lat: 0.0,
                lng: 0.0,
                radius: 0,
            };
            startlocations.push(locationData)
            console.log(startlocations)
            // Clear input fields after adding the location
            startLocationInput.value = "";
            startLocationRadius.value = "";


        }
        if (startstate.style.display == "none") {
            if (startLocationRadius.value === "") {
                startLocationRadius.value = 25;
            }

            if (startLocationInput.value !== "" || (startLocationInput.value !== "" && startLocationRadius.value === "")) {
                var city = startLocationInput.value.split(",")[0];
                var state = startLocationInput.value.split(",")[1].split(" ").join(""); // Replace "some_state" with the actual state (e.g., "CA")
                var radius = parseInt(startLocationRadius.value);


                // Get latitude and longitude from the CSV data
                getLatLngFromCSV(city, state)
                    .then(function (latLng) {
                        var targetCity = city;
                        var targetState = state;
                        var targetLat = latLng.lat;
                        var targetLng = latLng.lng;

                        var hasLocation = startlocations.some(function (location) {
                            return (
                                location.city === targetCity &&
                                location.state === targetState &&
                                location.lat === targetLat &&
                                location.lng === targetLng
                            );
                        });
                        if (hasLocation) {
                            startLocationInput.value = "";
                            startLocationRadius.value = "";
                        }
                        if (!hasLocation) {


                            if (latLng) {
                                var locationData = {
                                    state: state,
                                    city: city,
                                    lat: latLng.lat,
                                    lng: latLng.lng,
                                    radius: parseInt(startLocationRadius.value),
                                };

                                // Save locationData to the JSON file using your preferred method (e.g., AJAX, fetch, etc.)
                                // Replace `saveLocationDataToJSONFile` with the actual function to save the data

                            }

                            console.log(city, state, radius)
                            var locationCard = document.createElement("div");
                            locationCard.className = "location-card";

                            locationCard.textContent = city + ", " + state + ", " + startLocationRadius.value + " miles around";

                            var removeButton = document.createElement("button");
                            removeButton.textContent = "X";
                            removeButton.classList.add("Minus");
                            removeButton.id = startlocations.length
                            removeButton.addEventListener("click", function () {
                                startLocationsContainer.removeChild(locationCard);
                                console.log(removeButton.id)
                                startlocations.splice(parseInt(removeButton.id), 1)
                                var minusButtons = startLocationsContainer.getElementsByClassName("Minus");

                                // Loop through each button and update its ID
                                for (var i = 0; i < minusButtons.length; i++) {
                                    minusButtons[i].id = i.toString();
                                }
                                console.log(startlocations)
                            });
                            startlocations.push(locationData)
                            console.log(startlocations)


                            // Get all the button elements with class "Minus" inside the container

                            locationCard.appendChild(removeButton);

                            startLocationsContainer.appendChild(locationCard);
                            // Clear input fields after adding the location
                            startLocationInput.value = "";
                            startLocationRadius.value = "";
                        }
                    })
            }
        }
    }

    function addEndLocation() {
        var endLocationInput = document.getElementById("end-location-input");
        var endLocationRadius = document.getElementById("end-location-radius");
        var endLocationsContainer = document.getElementById("end-locations-container");
        var endstate = document.getElementById("end-location-input-state")
        if (endstate.style.display == "block") {
            var hasAL = endlocations.some(function (location) {
                return location.state === endstate.value;
            });

            if (hasAL) {
                endLocationInput.value = "";
                endLocationRadius.value = "";
                return
            }
            var locationCard = document.createElement("div");
            locationCard.className = "location-card";

            locationCard.textContent = endstate.value;

            var removeButton = document.createElement("button");
            removeButton.textContent = "X";
            removeButton.classList.add("Minus");
            removeButton.id = endlocations.length
            removeButton.addEventListener("click", function () {
                endLocationsContainer.removeChild(locationCard);
                console.log(removeButton.id)
                endlocations.splice(parseInt(removeButton.id), 1)
                var minusButtons = endLocationsContainer.getElementsByClassName("Minus");

                // Loop through each button and update its ID
                for (var i = 0; i < minusButtons.length; i++) {
                    minusButtons[i].id = i.toString();
                }
                console.log(endlocations)
            });


            // Get all the button elements with class "Minus" inside the container

            locationCard.appendChild(removeButton);

            endLocationsContainer.appendChild(locationCard);
            var locationData = {
                state: endstate.value,
                city: "",
                lat: 0.0,
                lng: 0.0,
                radius: 0,
            };
            endlocations.push(locationData)
            console.log(endlocations)
            // Clear input fields after adding the location
            endLocationInput.value = "";
            endLocationRadius.value = "";


        }
        if (endstate.style.display == "none") {
            if (endLocationRadius.value === "") {
                endLocationRadius.value = 25;
            }

            if (endLocationInput.value !== "" || (endLocationInput.value !== "" && endLocationRadius.value === "")) {
                var city = endLocationInput.value.split(",")[0];
                var state = endLocationInput.value.split(",")[1].split(" ").join(""); // Replace "some_state" with the actual state (e.g., "CA")
                var radius = parseInt(endLocationRadius.value);





                // Get latitude and longitude from the CSV data
                getLatLngFromCSV(city, state)
                    .then(function (latLng) {
                        var targetCity = city;
                        var targetState = state;
                        var targetLat = latLng.lat;
                        var targetLng = latLng.lng;

                        var hasLocation = endlocations.some(function (location) {
                            return (
                                location.city === targetCity &&
                                location.state === targetState &&
                                location.lat === targetLat &&
                                location.lng === targetLng
                            );
                        });
                        if (hasLocation) {
                            endLocationInput.value = "";
                            endLocationRadius.value = "";
                        }
                        if (!hasLocation) {
                            if (latLng) {
                                var locationData = {
                                    state: state,
                                    city: city,
                                    lat: latLng.lat,
                                    lng: latLng.lng,
                                    radius: parseInt(endLocationRadius.value),
                                };

                                // Save locationData to the JSON file using your preferred method (e.g., AJAX, fetch, etc.)
                                // Replace `saveLocationDataToJSONFile` with the actual function to save the data

                            }


                            var locationCard = document.createElement("div");
                            locationCard.className = "location-card";

                            locationCard.textContent = city + ", " + state + ", " + endLocationRadius.value + " miles around";

                            var removeButton = document.createElement("button");
                            removeButton.textContent = "X";
                            removeButton.classList.add("Minus");
                            removeButton.id = endlocations.length
                            removeButton.addEventListener("click", function () {
                                endLocationsContainer.removeChild(locationCard);
                                console.log(removeButton.id)
                                endlocations.splice(parseInt(removeButton.id), 1)
                                var minusButtons = endLocationsContainer.getElementsByClassName("Minus");

                                // Loop through each button and update its ID
                                for (var i = 0; i < minusButtons.length; i++) {
                                    minusButtons[i].id = i.toString();
                                }
                                console.log(endlocations)
                            });

                            endlocations.push(locationData)
                            console.log(endlocations)
                            // Get all the button elements with class "Minus" inside the container

                            locationCard.appendChild(removeButton);

                            endLocationsContainer.appendChild(locationCard);
                            // Clear input fields after adding the location
                            endLocationInput.value = "";
                            endLocationRadius.value = "";

                        }


                    })
            }
        }
    }



    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.MainButton.setText("DONE"); //изменяем текст кнопки иначе
    tg.MainButton.textColor = "#F2F2F2"; //изменяем цвет текста кнопки
    tg.MainButton.color = "#212426"; //изменяем цвет бэкграунда кнопки
    tg.MainButton.show()
    Telegram.WebApp.onEvent('mainButtonClicked', function () {
        var searchname = document.getElementById('searchname').value
        alldata = {
            searchname: searchname,
            startlocations: startlocations,
            endlocations: endlocations,
            vehtypes: vehtypes,
            trailertype: trailertype,
            vehstatus: vehstatus,
            vehmin: vehmin,
            vehmax: vehmax,
            deliverydate: deliverydate,
            readytoshipwithin: readytoshipwithin,
            minpayment: minpayment,
            minpaymentpermile: minpaymentpermile,
        }
        tg.sendData(JSON.stringify(alldata));
        //при клике на основную кнопку отправляем данные в строковом виде
    });


</script>


</html>
